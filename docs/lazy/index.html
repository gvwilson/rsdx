<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Research Software Design by Example &middot; A Lazy Algorithm</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


  </head>
  <body>
    <main>
      <div class="row notex">
  <div class="col-12 center">
    
      <h1>A Lazy Algorithm</h1>
    
  </div>
</div>

      
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../perf/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../scale/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


      <ul class="keypoints">
<li>Estimating algorithm performance with big-oh.</li>
<li>Extending a class hierarchy to accommodate new features.</li>
<li>Adapting tools written earlier to make all of this simpler to run, test, and document.</li>
</ul>
      
      <ul>
<li>Start with the punchline and work backward</li>
<li>The bottom lines in this graph show the performance we can get by changing our implementation of invasion percolation</li>
</ul>
<figure id="lazy_example">
<img src="././k+lazy+list+array_z+35+55+75+95+115_d+2+10+100_r+50_s+556677.svg" alt="Line graph showing that the lazy algorithm&rsquo;s performance is nearly flat."/>
<figcaption>Figure&nbsp;7.1: Running times for various depths and sizes.</figcaption>
</figure>

<h2 id="lazy-eval">Lazy Evaluation</h2>
<ul>
<li>We have been searching the entire grid to find the next cell to fill<ul>
<li>But we only need to look on the border</li>
<li>And we can keep track of where the border is</li>
</ul>
</li>
<li>Keep a dictionary called <code>candidates</code><ul>
<li>Key: a value in the grid</li>
<li>Values: coordinates of cells on the border that have that value</li>
</ul>
</li>
<li>On each step:<ul>
<li>Find the lowest key</li>
<li>Choose one of its cells at random (to solve the bias problem discovered earlier)</li>
<li>Fill it in</li>
<li>Add its unfilled neighbors to <code>candidates</code></li>
</ul>
</li>
<li>Trading space for time<ul>
<li>Storing cell values and coordinates is redundant</li>
<li>But filling the next cell now takes constant time regardless of grid size</li>
</ul>
</li>
<li><code>GridLazy</code> constructor</li>
</ul>
<div class="language-py" title="grid_lazy.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct and fill.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>
</div>
<ul>
<li>Filling algorithm overrides inherited method<ul>
<li>Fill the center cell</li>
<li>Add its neighbors as candidates</li>
<li>Repeatedly choose a cell to fill (stopping if we&rsquo;ve reached the boundary)</li>
</ul>
</li>
</ul>
<div class="language-py" title="grid_lazy.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill grid one cell at a time.&quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_filled</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_candidates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_cell</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_filled</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_border</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">num_filled</span>
</code></pre></div>
</div>
<ul>
<li>Adding candidates</li>
</ul>
<div class="language-py" title="grid_lazy.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add candidates around (x, y).&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_one_candidate</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_one_candidate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">iy</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="language-py" title="grid_lazy.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_one_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add (x, y) if suitable.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">()):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</code></pre></div>
</div>
<ul>
<li>Choosing a cell</li>
</ul>
<div class="language-py" title="grid_lazy.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">choose_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Choose the next cell to fill.&quot;&quot;&quot;</span>
    <span class="n">min_key</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="p">[</span><span class="n">min_key</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">available</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">available</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="p">[</span><span class="n">min_key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_candidates</span><span class="p">[</span><span class="n">min_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_candidates</span><span class="p">(</span><span class="o">*</span><span class="n">choice</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">choice</span>
</code></pre></div>
</div>
<ul>
<li>Sweep the same parameter ranges as before</li>
<li>Performance is much better<ul>
<li>Searching an \( N{\times}N \) grid is \( N^2 \) operations</li>
<li>Fill about \( N^{1.5} \) cells (it&rsquo;s a fractal)</li>
<li>So running time of the naïve approach is proportional to \( N^{3.5} \)</li>
<li>Which a computer scientist would write \( \mathcal{O}(N^{3.5}) \)</li>
<li>Running time of lazy approach is just \( \mathcal{O}(N^{1.5}) \)</li>
</ul>
</li>
</ul>
<h2 id="lazy-test">Testing</h2>
<p class="fixme">FIXME: show how to test lazy approach with randomnmess</p>

<h2 id="lazy-exercises">Exercises</h2>
<ol>
<li>
<p>Modify the list and array implementation to collect candidate cells of equal lowest value
    and select one of those.</p>
</li>
<li>
<p>Does it make sense to pre-populate <code>candidates</code> by adding <em>all</em> cells in the grid
    at the start of the program?
    Why or why not?</p>
</li>
</ol>
    </main>
    <footer>
  © 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/rsdx">repository</a>
  &middot;
  <a href="../license/">license</a>
</footer>

  </body>
</html>
